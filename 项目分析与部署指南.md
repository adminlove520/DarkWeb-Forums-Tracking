# 🕵️ DarkWeb Forums Tracker 项目分析与部署指南

## 📋 项目概述

### 项目简介
DarkWeb Forums Tracker 是一个自动化暗网论坛监控工具，使用 AI 代理抓取论坛帖子，检测关键词警报，并将专业威胁情报直接发送到 Discord。

### 解决的问题
- **⏰ 手动监控耗时** - 无需每天手动检查多个论坛
- **🌙 不错过重要信息** - 24/7 自动监控，关键信息实时推送
- **📊 信息过载** - 智能筛选，只推送与您相关的内容
- **🔄 重复劳动** - 自动化完成相同的日常监控工作
- **📱 团队共享困难** - 直接通过 Discord 分享给团队
- **🛡️ 隐身需求** - 避免被论坛检测和封锁

### 核心功能
- ✅ 每 4 小时自动监控暗网论坛
- ✅ AI 代理抓取和分析论坛帖子
- ✅ 智能去重，只处理新帖子
- ✅ 高级关键词匹配和实体检测
- ✅ 2 次尝试重试系统
- ✅ 截图捕获和 AI 摘要生成
- ✅ Discord 实时警报推送
- ✅ 数据库存储，支持历史分析
- ✅ 基于 VNC 的人工干预界面

## 🛠️ 技术栈

| 工具 | 用途 |
|------|------|
| [n8n](https://n8n.io) | 可视化工作流管理，连接所有组件 |
| [Playwright MCP](https://github.com/microsoft/playwright-mcp) | AI 驱动的浏览器自动化，具有隐身功能 |
| [Google Gemini](https://ai.google.dev) | LLM，用于读取和分析论坛内容 |
| [Supabase](https://supabase.com) | 云 PostgreSQL 数据库，用于存储帖子和截图 |
| [Discord Webhooks](https://discord.com) | 实时警报推送 |
| [Docker](https://docker.com) | 容器化部署，简化安装和管理 |
| [VNC](https://www.realvnc.com/) | 基于 Web 的浏览器 GUI，用于手动干预 |

## 🚀 部署指南

### 🔧 前置条件
- **Docker** (v20.10+) 和 **Docker Compose** (v2.0+)
- **Git** 用于克隆仓库
- **Supabase Cloud 账户** (免费套餐可用)
- **Google Gemini API Key** (可从 [Google AI Studio](https://aistudio.google.com/) 免费获取)
- **Discord Webhook URL** 用于接收通知

### 1️⃣ 克隆仓库

```bash
git clone https://github.com/brunosergi/darkweb-forums-tracker.git
cd darkweb-forums-tracker
cp .env.example .env
```

### 2️⃣ Supabase 配置

#### 创建 Supabase 项目
1. 访问 [supabase.com](https://supabase.com) 并创建新项目
2. 从 `Settings → API` 复制项目 URL 和服务角色密钥

#### 运行数据库脚本
1. 登录 Supabase 控制台
2. 进入 `SQL Editor`
3. 复制并运行 `supabase/supabase.sql` 中的完整脚本

#### 创建截图存储桶
1. 进入 `Storage`
2. 创建名为 `screenshots` 的新存储桶
3. 设置为 **公开** (Discord 嵌入需要)
4. 可选：设置 500KB 上传限制并限制为 `image/jpeg`

### 3️⃣ 配置环境变量

编辑 `.env` 文件，配置以下关键变量：

```bash
# Supabase Cloud 配置
SUPABASE_URL=https://your-project.supabase.co

# N8N 配置（生成强随机字符串）
N8N_ENCRYPTION_KEY=your-super-secret-key-here-32-chars-min

# 数据库配置
POSTGRES_PASSWORD=your-super-secret-and-long-postgres-password
POSTGRES_DB=postgres
```

### 4️⃣ 启动服务

```bash
docker compose up -d
```

这将自动：
- 设置 N8N 的 PostgreSQL 数据库
- 配置 N8N 队列管理的 Redis
- 启动带有 VNC 支持和共享浏览器会话的 Playwright MCP
- 导入带有增强 AI 代理和重试逻辑的 N8N 工作流
- 启动所有带有健康检查的服务

### 5️⃣ 验证服务运行状态

```bash
docker compose ps
```

所有服务应显示 "healthy" 状态。

## 🔧 N8N 配置

### 访问 N8N 编辑器

1. 打开 **http://localhost:5678**
2. 创建管理员账户（首次设置）
3. 配置凭证（这是唯一需要手动配置的步骤）

### 添加凭证

#### 1. Supabase API 凭证
- **名称**: `Supabase Cloud`
- **URL**: 您的 Supabase 项目 URL (例如: `https://your-project.supabase.co`)
- **服务角色密钥**: 从 Supabase 控制台 `Settings → API` 获取

#### 2. Google Gemini 凭证
- **名称**: `Gemini API`
- **API Key**: 从 [Google AI Studio](https://aistudio.google.com/) 获取

#### 3. Discord Webhook 凭证

**创建 Discord Webhook**:
1. 选择要接收论坛通知的 Discord 频道
2. 右键点击频道 → **编辑频道**
3. 进入 **集成** 标签页
4. 点击 **创建 Webhook** (或 **查看 Webhooks** → **新建 Webhook**)
5. 配置机器人名称和频道
6. 复制 Webhook URL

**添加到 N8N**:
- **名称**: `Discord Webhook`
- **Webhook URL**: 粘贴复制的 Discord Webhook URL
- **测试**: 发送测试消息以验证 Webhook 工作正常

### 更新工作流凭证

**重要**: 即使节点没有显示错误，也需要手动验证以下工作流中的凭证：

#### darkweb-get-forum-posts 工作流
- "AI Agent" → "Google Gemini Chat Model" 节点
- "Supabase RPC Check Existing URLs" → "Supabase RPC" HTTP 请求节点
- "Add Posts to Supabase" → Supabase 节点
- 所有 Discord 节点
- "Keywords" → 配置实体字典，包含规范名称和变体

#### darkweb-send-forum-posts-to-discord 工作流
- "AI Agent" → "Google Gemini Chat Model" 节点
- "Add Screenshot File to Supabase Bucket" → "Supabase RPC" HTTP 请求节点
- "Update Alert Post" → Supabase 更新节点
- "Update as Alert Post Error" → Supabase 更新节点
- "Update Sent Status" → Supabase 更新节点
- 所有 Discord 节点

### 激活工作流

1. 进入 N8N 中的 **工作流**
2. 点击以下两个工作流的 **激活** 开关：
   - `darkweb-get-forum-posts` (带有重试逻辑和实体检测的主要监控工作流)
   - `darkweb-send-forum-posts-to-discord` (Discord 通知 + 带有增强日志的警报帖子 AI 代理工作流)

## 🖥️ VNC 配置（人工干预）

### 访问 VNC 界面

**Web 浏览器（推荐）**: http://localhost:6080
- 无需安装软件
- 适用于任何现代浏览器
- 点击 "Connect" 访问桌面

**VNC 客户端**: `localhost:5900`
- 使用 TightVNC、RealVNC 或任何 VNC 查看器
- 无需密码（开发模式）

### 何时使用 VNC

- **CAPTCHA 解决**: 当 AI 代理在 DDoS-Guard 或论坛 CAPTCHA 上卡住时
- **手动登录**: 首次登录受保护的论坛
- **会话恢复**: 当登录会话过期时重新认证
- **机器人检测**: 绕过需要人工交互的反机器人措施

### 手动浏览器控制

当需要手动启动 Chromium 进行故障排除、认证或 CAPTCHA 解决时：

**VNC Web 界面**:
- 按下 **Alt+F2** 并输入: `chromium`
- 或右键点击桌面 → 应用程序 → 运行终端并输入: `chromium &`

**容器终端**:
```bash
docker exec -it darkweb-forums-tracker-playwright bash
chromium &
```

这非常适合解决 CAPTCHA、设置认证 cookie、调试失败的抓取或手动导航 AI 代理无法自动处理的复杂登录流程。

## 🎉 开始监控论坛

### 验证一切正常工作

1. **检查 N8N**: http://localhost:5678 - 两个工作流都应处于活动状态
2. **测试 VNC**: http://localhost:6080 - 应显示带有浏览器的桌面
3. **检查 Discord**: 验证 Webhook URL 工作正常
4. **数据库**: 确认 Supabase 中存在 `darkweb_forums` 表

### 监控执行

**系统每 4 小时自动运行，但您可以**:
- **手动触发**: 在 N8N 中手动执行工作流进行测试
- **检查日志**: 在 N8N 中查看执行日志进行调试
- **VNC 监控**: 通过 VNC 实时观察浏览器自动化
- **Discord 更新**: 接收扫描开始/完成/失败的通知

### 预期 Discord 流程

1. **"Forum tracking started"** - 扫描开始，带有跟踪通知
2. **论坛帖子** - 普通帖子（蓝色）和实体警报（红色，带有截图和 AI 摘要）
3. **重试通知** - 如果初始尝试失败，显示黄色警报
4. **"Forum tracking completed"** - 扫描完成，带有时间戳和处理统计

## 🔄 自定义配置

### 添加更多论坛

**在 `darkweb-get-forum-posts` 工作流中**:
1. 更新 "DarkForums.st Metadata" 节点
2. 向论坛列表添加新的论坛 URL
3. 修改 AI 代理提示以适应论坛特定的解析

### 配置实体检测关键词

**在 `darkweb-get-forum-posts` 工作流中**:
1. 找到 "Keywords" 节点
2. 使用规范名称和变体更新实体字典：
```javascript
[
  ["lockbit"],
  ["facebook", "meta"],
  ["bank of america", "bak"],
  ["united states", "united states of america", " usa ", "american"],
  ["brasil", "brazil", ".br", ".com.br", "brazilian"],
  ["twitter", "x.com", "tweet"]
]
```

**注意**: 每个数组代表一个实体 - 第一个元素是规范名称，其他是变体/别名。

### 更改 AI 模型

**从 Gemini 切换到其他模型**:
1. 在 N8N 中添加新的 AI 提供商凭证
2. 替换 "Google Gemini Chat Model" 节点
3. 更新不同模型能力的提示

## 🔧 故障排除

### 常见问题

**N8N 凭证错误**:
- 验证所有凭证都已保存在 N8N UI 中
- 检查 Supabase URL 和服务角色密钥
- 在 N8N 凭证设置中测试凭证

**工作流执行失败**:
- 检查 Google Gemini API 配额/速率限制（重试逻辑将尝试 2 次）
- 验证 Playwright MCP 在端口 8831 可访问
- 确保 Discord Webhook URL 有效
- 在 N8N 执行日志中监控重试尝试

**VNC 连接问题**:
- 确认端口 6080 可访问
- 检查 Docker 容器日志: `docker logs darkweb-forums-tracker-playwright`
- 如有需要，重启 Playwright 容器

**截图上传失败**:
- 确保 Supabase `screenshots` 存储桶存在且公开
- 验证服务角色密钥具有存储权限
- 检查存储桶大小限制和文件类型限制

**论坛访问被阻止**:
- 使用 VNC 手动解决 CAPTCHA
- 考虑添加代理支持以进行 IP 轮换
- 检查论坛是否需要登录/注册

### 数据库问题

**缺少表错误**:
```bash
# 在 Supabase SQL Editor 中验证表是否存在于新架构中
SELECT id, post_title, post_date, last_post_date, post_alert, entity_name 
FROM public.darkweb_forums LIMIT 1;

# 如果缺少或架构过时，重新运行 supabase/supabase.sql 脚本
```

**RLS（行级安全）警告**:
- 更新后的 `supabase/supabase.sql` 脚本包含适当的 RLS 策略
- 如果看到 RLS 警告，重新运行脚本

### 重置一切

```bash
# 重置本地容器（保留 Supabase 云数据）
docker compose down -v --remove-orphans
docker compose up -d

# 如有需要，在 N8N 中重新导入工作流
# 在 N8N UI 中重新配置凭证
```

## 📊 监控与维护

### 性能监控

- **N8N 执行**: 监控工作流成功/失败率
- **Supabase 使用**: 跟踪数据库存储和 API 调用
- **Discord 速率限制**: 确保 Webhook 调用保持在限制范围内
- **VNC 使用**: 监控浏览器资源消耗

### 定期维护

- **关键词更新**: 每月审核并更新警报关键词
- **论坛列表**: 添加新的相关论坛
- **凭证轮换**: 定期更新 API 密钥和密码
- **日志清理**: 归档 N8N 中的旧执行日志

## 📱 服务 URL

| 服务 | URL | 用途 |
|------|-----|------|
| **N8N 工作流** | http://localhost:5678 | 自动化管理 |
| **VNC 浏览器** | http://localhost:6080 | 人工干预界面 |
| **Supabase 控制台** | 您的云项目 URL | 数据库管理 |
| **Playwright MCP** | http://localhost:8831 | 浏览器自动化服务 |

## 🤝 项目架构

### 核心工作流

1. **darkweb-get-forum-posts**:
   - 每 4 小时触发
   - 抓取论坛帖子
   - 去重处理
   - 关键词匹配
   - 存储到数据库

2. **darkweb-send-forum-posts-to-discord**:
   - 处理数据库中的新帖子
   - 为匹配关键词的帖子生成 AI 摘要和截图
   - 通过 Discord 发送通知
   - 更新帖子状态

### 数据流程

1. **抓取**: Playwright MCP 抓取论坛帖子
2. **处理**: N8N 工作流处理和分析帖子
3. **存储**: 帖子存储在 Supabase 数据库中
4. **通知**: 匹配关键词的帖子通过 Discord 发送
5. **人工干预**: 必要时通过 VNC 进行人工干预

## 📝 总结

DarkWeb Forums Tracker 是一个功能强大的自动化暗网论坛监控工具，通过 AI 代理、自动化工作流和实时通知，帮助您和您的团队及时了解暗网威胁情报。

该项目采用模块化设计，易于部署和扩展，适合：
- **SOC 团队** - 新兴威胁的早期预警系统
- **威胁猎手** - 监控威胁行为者通信和 TTP
- **威胁情报分析师** - 自动化暗网数据收集
- **安全经理** - 地下活动的执行摘要
- **安全顾问** - 为客户提供威胁情报服务
- **MSP 团队** - 监控针对客户行业的威胁

通过按照本指南进行部署和配置，您可以快速启动并运行这个强大的工具，开始自动监控暗网论坛并接收实时威胁情报警报。

---

**祝您使用愉快！** 🛡️

[📖 官方文档](https://github.com/brunosergi/darkweb-forums-tracker) | [⚙️ 工作流](n8n/workflows)